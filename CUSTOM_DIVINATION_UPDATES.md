# 梅花易数自定义起卦功能更新总结

## 🎯 更新概述
为梅花易数添加了完整的自定义起卦功能，允许用户指定自定义的年月日时和数字，同时修复了传统动爻计算公式和追问功能。

## 📋 完成的功能清单

### ✅ 1. 数据模型更新
**文件**: `src/models.py`
- 在 `PlumFlower` 模型中添加了：
  - `custom_datetime`: 自定义起卦时间（格式：YYYY-MM-DD HH:MM:SS）
  - `use_custom_time`: 是否使用自定义时间的布尔标志

### ✅ 2. 后端算法更新
**文件**: `src/divination/plum_flower.py`
- 添加了自定义时间解析逻辑
- 支持时间格式验证（YYYY-MM-DD HH:MM:SS）
- 当 `use_custom_time=false` 时使用当前时间
- 当 `use_custom_time=true` 时使用用户指定的时间

### ✅ 3. 传统动爻公式修正
**文件**: `src/algorithms/meihua/core.py`
- 修正动爻计算为传统公式：`(上卦数 + 下卦数 + 时辰数) % 6`
- 添加 `zhong_gua_total` 字段记录重卦总数
- 更新格式化器显示重卦总数计算过程

### ✅ 4. 前端界面更新
**文件**: `frontend/src/views/Index.vue`
- 添加了时间选择模式：当前时间 vs 自定义时间
- 集成了 Naive UI 的日期时间选择器
- 添加了时间影响动爻的说明提示
- 更新了算法描述文字

### ✅ 5. 追问功能修复
**文件**: `src/chatgpt_router.py`
- 修复了追问时 `plum_flower` 对象重建问题
- 从旧的 `num1/num2` 格式更新为新的 `number/use_custom_time/custom_datetime` 格式
- 确保追问时能正确恢复原始起卦参数

### ✅ 6. 格式化输出优化
**文件**: `src/algorithms/meihua/formatter.py`
- 更新输出格式显示重卦总数计算过程
- 明确标注传统公式的使用
- 优化时辰信息的显示

## 🧪 测试验证

### 核心功能测试
- ✅ 自定义时间起卦算法
- ✅ 当前时间起卦算法  
- ✅ 传统动爻公式验证
- ✅ 不同时辰对比测试
- ✅ 边界情况处理

### API集成测试
- ✅ 数据模型验证
- ✅ 后端API处理
- ✅ 错误处理（无效时间格式）
- ✅ 追问功能恢复

### 端到端测试
- ✅ 前端界面功能
- ✅ 后端API集成
- ✅ 数据传递正确性

## 🚀 使用方法

### 前端使用
1. 在梅花易数页面选择"自定义时间"选项
2. 使用日期时间选择器指定起卦时间
3. 输入起卦数字（1-32位）
4. 系统会使用传统公式计算动爻

### API调用示例
```json
{
  "prompt": "测试自定义时间起卦",
  "prompt_type": "plum_flower",
  "birthday": "2000-01-01 12:00:00",
  "plum_flower": {
    "number": "258",
    "use_custom_time": true,
    "custom_datetime": "2024-06-21 15:30:00"
  }
}
```

### 传统公式说明
- **上卦数**: 前半部分数字之和 % 8
- **下卦数**: 后半部分数字之和 % 8  
- **时辰数**: 按传统十二时辰计算（子1，丑2...亥12）
- **动爻**: (上卦数 + 下卦数 + 时辰数) % 6

## 📝 技术细节

### 时辰计算
- 子时: 23:00-01:00 (数字1)
- 丑时: 01:00-03:00 (数字2)
- 寅时: 03:00-05:00 (数字3)
- ... (依此类推)
- 亥时: 21:00-23:00 (数字12)

### 数字分割规则
- 偶数位数字：平分为二
- 奇数位数字：前半部分比后半部分少一位
- 单个数字：前后都使用该数字

### 错误处理
- 无效时间格式：返回HTTP 400错误
- 数字超长：前端限制32位
- 追问状态丢失：自动重建原始参数

## 🔧 维护说明

### 代码结构
- 核心算法：`src/algorithms/meihua/`
- API接口：`src/divination/plum_flower.py`
- 前端界面：`frontend/src/views/Index.vue`
- 数据模型：`src/models.py`

### 测试文件
- `test_custom_e2e.py`: 端到端测试
- `test_followup_fix.py`: 追问功能测试
- `final_verification.py`: 综合验证测试
- `src/algorithms/meihua/test_custom_divination.py`: 算法测试

## 🎉 总结
此次更新全面实现了梅花易数的自定义起卦功能，包括：
- 完整的前后端实现
- 传统公式的正确应用
- 追问功能的完美兼容
- 全面的测试验证

系统现在完全支持用户指定任意时间进行起卦，大大增强了梅花易数功能的实用性和准确性。